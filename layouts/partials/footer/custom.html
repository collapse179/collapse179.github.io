<!-- APlayer Dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<!-- PJAX Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script>

<!-- Topbar Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/topbar@0.1.3/topbar.min.js"></script>

<!-- Styles -->
<style>
    /* Table of Contents: Hide sub-levels by default */
    #TableOfContents ul ul,
    #TableOfContents ol ul,
    #TableOfContents ul ol,
    #TableOfContents ol ol {
        display: none;
    }

    #TableOfContents .open {
        display: block;
    }

    /* Back to Top Button */
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        background-image: url({{ (resources.Get "icons/backTop.svg").Permalink }});
        background-size: contain;
        background-repeat: no-repeat;
        transition: transform 0.3s ease;
    }

    #backTopBtn:hover {
        transform: scale(1.2);
    }

    /* Global Button & Widget Hover Effect */
    button, 
    .widget, 
    .menu-social li a,
    .site-avatar img {
        transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
    }
    
    button:hover, 
    .menu-social li a:hover,
    .site-avatar img:hover {
        transform: scale(1.1);
    }

    .widget:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }

    /* Article List, Tile & Search Result Hover Effect */
    .article-list--compact article,
    .article-list--tile article,
    .search-result--list article {
        transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
    }

    .article-list--compact article:hover,
    .article-list--tile article:hover,
    .search-result--list article:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }
</style>

<!-- HTML Elements -->
<div id="aplayer"></div>

<!-- Scripts -->
<script>
        // --- Topbar Config ---
        topbar.config({
            barColors: {
                "0": "rgba(255, 255, 255, 1)",
                "1.0": "rgba(0, 149, 234, 1)"
            }
        })

        // --- PJAX Initialization ---
        var pjax = new Pjax({
            selectors: [
                ".main-container",
                "title"
            ],
            cacheBust: true
        })

        // Handle PJAX Response (Fix Article Style)
        pjax._handleResponse = pjax.handleResponse;
        pjax.handleResponse = function (responseText, request, href, options) {
            if (request.responseText.match("<html")) {
                if (responseText) {
                    let newDom = new DOMParser().parseFromString(responseText, "text/html");
                    let bodyClass = newDom.body.className;
                    document.body.setAttribute("class", bodyClass)
                }
                pjax._handleResponse(responseText, request, href, options);
            } else {
                // handle non-HTML response here
            }
        }

        // PJAX Events
        document.addEventListener("pjax:send", () => {
            topbar.show();
        })

        document.addEventListener("pjax:complete", () => {
            topbar.hide();

            // Re-init Stack Theme Scripts
            if (window.Stack && window.Stack.init) {
                window.Stack.init();
            }

            // Re-render KaTeX
            renderKaTeX();

            // Re-load Giscus
            loadGiscus();
        })

        // --- Giscus Logic ---
        function loadGiscus() {
            const container = document.querySelector('.giscus-container');
            if (!container) return;

            const script = document.createElement('script');
            script.src = "https://giscus.app/client.js";
            
            // Determine current theme
            const isDark = document.documentElement.dataset.scheme === 'dark';
            const theme = isDark ? container.dataset.themeDark : container.dataset.themeLight;

            for (const attr of container.attributes) {
                if (attr.name.startsWith('data-')) {
                    script.setAttribute(attr.name, attr.value);
                }
            }
            
            // Set dynamic theme
            script.setAttribute('data-theme', theme);

            script.crossOrigin = "anonymous";
            script.async = true;
            
            container.innerHTML = '';
            container.appendChild(script);
        }

        // Listen for theme changes
        window.addEventListener('onColorSchemeChange', (e) => {
            const container = document.querySelector('.giscus-container');
            if (!container) return;

            const newTheme = e.detail === 'dark' ? container.dataset.themeDark : container.dataset.themeLight;
            
            const iframe = document.querySelector('iframe.giscus-frame');
            if (iframe) {
                iframe.contentWindow.postMessage({ 
                    giscus: { 
                        setConfig: { 
                            theme: newTheme 
                        } 
                    } 
                }, 'https://giscus.app');
            }
        });

        // Initial load
        loadGiscus();

        // --- KaTeX Logic ---
        async function renderKaTeX() {
            let katex = document.querySelector(".math-katex");
            if (!katex) return;

            while (typeof renderMathInElement !== "function") {
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false },
                    { left: "\\(", right: "\\)", display: false },
                    { left: "\\[", right: "\\]", display: true }
                ],
                ignoredClasses: ["gist"]
            });
        }

        // --- APlayer Initialization ---
        const ap = new APlayer({
            container: document.getElementById("aplayer"),
            audio: [
                {
                    name: "Tic! Tac! Toe!",
                    artist: "TAK x Corbin",
                    url: "/music/01 TAK x Corbin - Tic! Tac! Toe!.mp3",
                    cover: "/img/cover.jpg"
                },
                {
                    name: "Bambi - DJMAX Edit -",
                    artist: "DAZBEE",
                    url: "/music/02 DAZBEE - Bambi - DJMAX Edit -.mp3",
                    cover: "/img/cover.jpg"
                }
            ],
            fixed: true
        });

        // --- APlayer State Persistence ---
        window.addEventListener("beforeunload", () => {
            const playInfo = {
                index: ap.list.index,
                currentTime: ap.audio.currentTime,
                paused: ap.paused
            };
            localStorage.setItem("playInfo", JSON.stringify(playInfo));
        });

        window.addEventListener("load", () => {
            const playInfo = JSON.parse(localStorage.getItem("playInfo"));
            if (!playInfo) return;

            ap.list.switch(playInfo.index);
            setTimeout(() => {
                ap.seek(playInfo.currentTime);
                if (!playInfo.paused) {
                    ap.play();
                }
            }, 500);
        });

        // --- TOC Auto-Collapse Logic ---
        function initTocHide() {
            const toc = document.querySelector(".widget--toc");
            if (!toc) return;

            window.addEventListener("scroll", function () {
                const openUls = document.querySelectorAll(".open");
                openUls.forEach(ul => ul.classList.remove("open"));

                const currentLi = document.querySelector(".active-class");
                if (!currentLi) return;

                if (currentLi.children.length > 1) {
                    currentLi.children[1].classList.add("open");
                }

                let ul = currentLi.parentElement;
                while (ul && (ul.tagName === "UL" || ul.tagName === "OL")) {
                    ul.classList.add("open");
                    ul = ul.parentElement.parentElement;
                }
            });
        }
        initTocHide();

        // --- Back to Top Button Logic ---
        function initScrollTop() {
        // Remove existing button if any (to prevent duplicates)
        const existingBtn = document.getElementById("backTopBtn");
        if (existingBtn) existingBtn.remove();

        const btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" });
        
        // Append to body to ensure visibility on all pages
        document.body.appendChild(btn);

        window.addEventListener("scroll", function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        });
        }
        initScrollTop();


    </script>